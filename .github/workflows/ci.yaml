name: CI

on:
  push:
    branches: [main, develop, ci-test]
    paths:
      - "apps/**"
      - "packages/**"
      - "infra/**"
      - "pnpm-*.yaml"
      - "package.json"
      - "pnpm-workspace.yaml"
      - ".github/workflows/ci.yaml"
  pull_request:
    branches: [main, develop]
    paths:
      - "apps/**"
      - "packages/**"
      - "infra/**"
      - "pnpm-*.yaml"
      - "package.json"
      - "pnpm-workspace.yaml"
      - ".github/workflows/ci.yaml"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-lint:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      # 1) Checkout
      - name: Checkout
        uses: actions/checkout@v4

      # 2) Node + Corepack (pnpm)
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
            version: 9.15.0
            run_install: false

      - name: Setup Node.js (22.x) + Corepack
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "pnpm"
      - name: Enable Corepack
        run: corepack enable

      # 3) pnpm install (workspace completo)
      - name: Install deps (all packages)
        run: pnpm install --frozen-lockfile

      # 4) Build packages necesarios primero
      - name: Build @aa/types (required by web)
        run: pnpm -C packages/types build

      # 5) Lint y formato (web) — rápido feedback de frontend
      - name: Lint (web)
        run: pnpm -C apps/web lint
      - name: Prettier check (web)
        run: pnpm -C apps/web format

      # 6) Build (web) — atrapa errores de imports/transpile
      - name: Build (web)
        run: pnpm -C apps/web build

      # 7) Python 3.11 + cache pip
      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "apps/api/requirements*.txt"

      - name: Install API deps
        working-directory: apps/api
        run: |
          python -m pip install --upgrade pip
          # Install main dependencies
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          fi
          # Install dev dependencies if they exist
          if [ -f requirements-dev.txt ]; then 
            pip install -r requirements-dev.txt
          else
            # Install ruff and black directly if no dev requirements
            pip install ruff black
          fi

      # 8) Smoke test de API — valida que FastAPI está disponible
      - name: FastAPI smoke import
        run: python -c "import fastapi; print('FastAPI:', fastapi.__version__)"

      # 9) Lint/format (api) — Ruff/Black en árbol de API
      - name: Ruff check (api)
        working-directory: apps/api
        run: ruff check . --output-format=github

      - name: Ruff format check (api)
        working-directory: apps/api
        run: ruff format --check .

      - name: Black check (api)
        working-directory: apps/api
        run: black --check --diff .

      # 10) Grammar/types (sanity) — comprueba que los packages compilan
      - name: Build @aa/grammar (if needed)
        run: |
          if [ -f packages/grammar/package.json ]; then
            if pnpm -C packages/grammar run --help | grep -q "build"; then
              pnpm -C packages/grammar build
            else
              echo "No build script in @aa/grammar"
            fi
          else
            echo "No @aa/grammar package found"
          fi

      - name: Grammar TS codegen check
        run: |
          if [ -f packages/grammar/scripts/gen-ts.js ]; then 
            echo "Grammar TS codegen scripts exist"
            # Check if generated files are up to date
            if [ -d packages/grammar/src/ts ]; then
              echo "Generated TS files found"
            else
              echo "Warning: TS generation scripts exist but no generated files"
            fi
          else
            echo "No TS codegen scripts found"
          fi

      - name: Grammar Python codegen check
        run: |
          if [ -f packages/grammar/scripts/gen-py.js ]; then
            echo "Grammar Python codegen scripts exist"
            # Check if generated files are up to date
            if [ -d packages/grammar/py ]; then
              echo "Generated Python files found"
            else
              echo "Warning: Python generation scripts exist but no generated files"
            fi
          else
            echo "No Python codegen scripts found"
          fi

      # 11) Verification steps
      - name: Verify workspace structure
        run: |
          echo "=== Workspace Structure ==="
          ls -la
          echo "=== Apps ==="
          ls -la apps/
          echo "=== Packages ==="
          ls -la packages/
          echo "=== Web node_modules ==="
          ls -la apps/web/node_modules/.bin/ | head -10 || echo "No web node_modules"

      # 12) Test workspace scripts (if any)
      - name: Test workspace scripts
        run: |
          if pnpm run --help | grep -q "lint:all"; then
            echo "Testing lint:all script..."
            pnpm run lint:all
          else
            echo "No lint:all script found"
          fi

      # 13) Reporte de tamaños (opcional, útil para vigilar creep)
      - name: Disk usage report
        run: |
          echo "=== Disk Usage ==="
          du -sh apps/* packages/* 2>/dev/null || echo "Some paths not accessible"
          echo "=== Node Modules Size ==="
          du -sh node_modules apps/*/node_modules packages/*/node_modules 2>/dev/null || echo "Some node_modules not found"

  # Segundo job: Docker integration test
  docker-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build-lint

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Docker - Check compose files
        run: |
          if [ -f infra/docker-compose.yml ]; then
            echo "Found docker-compose.yml"
            docker compose -f infra/docker-compose.yml config
          else
            echo "No docker-compose.yml found, skipping Docker tests"
            exit 0
          fi

      - name: Docker - Test API build
        run: |
          if [ -f apps/api/Dockerfile ]; then
            echo "Testing API Docker build..."
            docker build -t test-api apps/api
            echo "API Docker build successful"
          else
            echo "No API Dockerfile found"
          fi

      - name: Docker - Test web build (if has Dockerfile)
        run: |
          if [ -f apps/web/Dockerfile ]; then
            echo "Testing web Docker build..."
            docker build -t test-web apps/web
            echo "Web Docker build successful"
          else
            echo "No web Dockerfile found, skipping"
          fi

      - name: Docker - Cleanup
        run: |
          docker image prune -f
          docker system df
