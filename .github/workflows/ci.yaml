name: CI

on:
  push:
    branches: [main, develop, ci-test]
    paths:
      - "apps/**"
      - "packages/**"
      - "infra/**"
      - "pnpm-*.yaml"
      - "package.json"
      - "pnpm-workspace.yaml"
      - ".github/workflows/ci.yaml"
  pull_request:
    branches: [main, develop]
    paths:
      - "apps/**"
      - "packages/**"
      - "infra/**"
      - "pnpm-*.yaml"
      - "package.json"
      - "pnpm-workspace.yaml"
      - ".github/workflows/ci.yaml"

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Job principal: Build cr√≠tico (debe pasar)
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
            version: 9.15.0
            run_install: false

      - name: Setup Node.js (22.x) + Cache
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "pnpm"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      # Setup Next.js build cache
      - name: Setup Next.js build cache
        uses: actions/cache@v4
        with:
          path: |
            apps/web/.next/cache
            apps/web/.next/static
          key: ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ hashFiles('apps/web/**/*.{js,jsx,ts,tsx,css,scss,json}') }}
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('**/pnpm-lock.yaml') }}-

      # Build packages en orden correcto
      - name: Build @aa/types
        run: pnpm -C packages/types build

      - name: Build @aa/grammar
        run: |
          if [ -f packages/grammar/package.json ]; then
            if pnpm -C packages/grammar run --help | grep -q "build"; then
              pnpm -C packages/grammar build
            else
              echo "No build script in @aa/grammar, using existing files"
            fi
          fi

      # Build cr√≠tico de web (debe pasar)
      - name: Build web app
        run: pnpm -C apps/web build:ci

      # Python setup y smoke test
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"
          cache-dependency-path: "apps/api/requirements*.txt"

      - name: Install FastAPI dependencies
        working-directory: apps/api
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then 
            pip install -r requirements.txt
          fi

      - name: FastAPI smoke test
        run: python -c "import fastapi; print('‚úÖ FastAPI:', fastapi.__version__)"

  # Job de calidad: Linting y formato (puede fallar sin detener deploy)
  quality:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    # Corre en paralelo, no bloquea el build principal

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
            version: 9.15.0
            run_install: false

      - name: Setup Node.js (22.x)
        uses: actions/setup-node@v4
        with:
          node-version: "22.x"
          cache: "pnpm"

      - name: Enable Corepack
        run: corepack enable

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build dependencies for linting
        run: |
          pnpm -C packages/types build
          if [ -f packages/grammar/package.json ]; then
            if pnpm -C packages/grammar run --help | grep -q "build"; then
              pnpm -C packages/grammar build
            fi
          fi

      # Frontend quality checks (warnings no fallan el job)
      - name: ESLint (web)
        run: |
          echo "üîç Running ESLint..."
          pnpm -C apps/web lint || {
            echo "‚ö†Ô∏è  ESLint found issues - please review and fix"
            echo "Run: pnpm -C apps/web lint --fix"
            exit 0
          }

      - name: Prettier (web)  
        run: |
          echo "üé® Checking code format..."
          pnpm -C apps/web format || {
            echo "‚ö†Ô∏è  Prettier found format issues - please fix"
            echo "Run: pnpm -C apps/web format:write"
            exit 0
          }

      # Python quality checks
      - name: Setup Python for linting
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python linting tools
        run: pip install ruff black

      - name: Ruff linting (api)
        working-directory: apps/api
        run: |
          echo "üêç Running Ruff..."
          ruff check . --output-format=github || {
            echo "‚ö†Ô∏è  Ruff found issues - please review and fix"
            echo "Run: ruff check . --fix"
            exit 0
          }

      - name: Black formatting (api)
        working-directory: apps/api
        run: |
          echo "üñ§ Checking Python format..."
          black --check --diff . || {
            echo "‚ö†Ô∏è  Black found format issues - please fix"  
            echo "Run: black ."
            exit 0
          }

  # Job de Docker: Verifica que las im√°genes construyen
  docker-integration:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build  # Solo corre si el build principal pasa

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test API Docker build
        run: |
          if [ -f apps/api/Dockerfile ]; then
            echo "üê≥ Testing API Docker build..."
            docker build -f apps/api/Dockerfile -t test-api .
            echo "‚úÖ API Docker build successful"
          else
            echo "‚ÑπÔ∏è  No API Dockerfile found"
          fi

      - name: Test docker-compose config
        run: |
          if [ -f infra/docker-compose.yml ]; then
            echo "üê≥ Testing docker-compose config..."
            docker compose -f infra/docker-compose.yml config
            echo "‚úÖ docker-compose config valid"
          else
            echo "‚ÑπÔ∏è  No docker-compose.yml found"
          fi

      - name: Cleanup
        run: docker image prune -f